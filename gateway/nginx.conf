worker_processes  1;
user              nobody;

events {
  worker_connections  1024;
  multi_accept        off;
}

http {
  include       mime.types;
  default_type  application/octet-stream;
  tcp_nopush    on;
  tcp_nodelay   on;
  sendfile      on;
  keepalive_timeout  65;

  # ---- HTTP -> HTTPS redirect for all hosts (clinic + reports) ----
  server {
    listen 80;
    return 301 https://$host$request_uri;
  }

  # =========================
  # OpenMRS (clinic.sitrucconsult.com)
  # =========================
  server {
    listen 443 ssl;
    server_name clinic.sitrucconsult.com;

    # Use the cert/key you already mounted for clinic.sitrucconsult.com
    ssl_certificate     /etc/nginx/certs/fullchain1.pem;
    ssl_certificate_key /etc/nginx/certs/privkey1.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # Proxy O3 SPA
    location /openmrs/spa {
      proxy_pass http://frontend/;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Proxy legacy UI and API
    location /openmrs {
      proxy_pass http://backend:8080;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      client_max_body_size 50m;
    }
  }

  # =========================
  # JasperReports (reports.clinic.sitrucconsult.com)
  # =========================
  server {
    listen 443 ssl;
    server_name reports.clinic.sitrucconsult.com;

    # >>> Replace these with the correct cert/key for *reports* domain.
    # If you're using a wildcard cert that covers both hosts, you can reuse the same files as above.
    ssl_certificate     /etc/nginx/certs/reports-fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/reports-privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # Canonicalize /reports (no trailing slash) if you later add a path prefix vhostâ€”currently unused.
    location = /reports { return 301 /reports/; }

    # Jasper runs at ROOT inside the container; proxy the whole vhost to it.
    location / {
      proxy_http_version 1.1;

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Port $server_port;

      proxy_pass http://jasperserver:8080/;   # note: trailing slash, ROOT context
      proxy_read_timeout 300s;

      # If you later encounter any absolute-path redirects from Jasper, this keeps them on this vhost
      proxy_redirect ~^/(.*)$ /$1;
    }
  }
}
